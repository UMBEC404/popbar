const a="http://localhost:4000";async function c(t){const o=await fetch(`${a}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({conversation:t})});if(!o.ok){const s=await o.text();throw new Error(`API error (${o.status}): ${s}`)}const e=await o.json();if(!e.message?.content)throw new Error("No response from API");return e.message}chrome.commands.onCommand.addListener(t=>{console.log("[Popbar] Command received:",t),t==="toggle_popbar"&&chrome.tabs.query({active:!0,currentWindow:!0},o=>{const e=o[0];if(!e?.id){console.warn("[Popbar] No active tab to send TOGGLE_POPBAR");return}chrome.tabs.sendMessage(e.id,{type:"TOGGLE_POPBAR"},()=>{chrome.runtime.lastError?console.warn("[Popbar] Failed to send TOGGLE_POPBAR:",chrome.runtime.lastError.message):console.log("[Popbar] TOGGLE_POPBAR sent to tab",e.id)})})});chrome.runtime.onMessage.addListener((t,o,e)=>{if(t?.type==="AI_CHAT"){const s=t.conversation??[];return c(s).then(r=>e({success:!0,message:r})).catch(r=>{const n=r instanceof Error?r.message:String(r);e({success:!1,error:n})}),!0}});
